<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Match Analytics System</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- html2canvas for Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- Chart.js for Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        navy: {
                            800: '#1e3a8a', 
                            900: '#0B1C2D', // Authority, structure
                        },
                        brand: {
                            blue: '#1E6FFF', // Primary actions
                            green: '#18B26B', // Success
                            gold: '#F2C94C', // Premium/Top
                            orange: '#F2994A', // Warning/Upcoming
                            white: '#FFFFFF'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        body {
            background-color: #f8fafc; /* Very light gray background */
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(226, 232, 240, 0.8);
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #1E6FFF;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Table sticky header */
        .table-container {
            overflow-x: auto;
            max-height: 70vh; /* Allow vertical scroll for footer */
        }
        thead th {
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        /* Sticky Footer */
        tfoot tr {
            position: sticky;
            bottom: 0;
            z-index: 10;
            background-color: #f8fafc;
            border-top: 2px solid #e2e8f0;
            box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        /* Card Hover Effects */
        .kpi-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .kpi-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        /* Tab Styles */
        .nav-tab {
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        
        /* Active Tab Gradient & Glow */
        .nav-tab.active {
            background: linear-gradient(90deg, #1E6FFF 0%, #18B26B 100%);
            color: white;
            box-shadow: 0 0 15px rgba(30, 111, 255, 0.3);
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        /* Inactive Tab Hover Line */
        .nav-tab.inactive:hover::after {
            content: '';
            position: absolute;
            bottom: 4px;
            left: 20%;
            width: 60%;
            height: 2px;
            background: linear-gradient(90deg, #1E6FFF, #18B26B);
            border-radius: 2px;
        }
        
        .nav-tab.inactive:hover {
            color: white;
        }

        /* Row Hover Effect & Blue Lines */
        .match-row {
            transition: all 0.2s ease;
            border-bottom: 1px solid #dbeafe; /* Blue lines in rows */
        }
        .match-row:last-child {
            border-bottom: none;
        }
        .match-row:hover {
            background-color: #ffffff !important;
            transform: scale(1.002);
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            border-left: 3px solid #1E6FFF;
            z-index: 5;
            position: relative;
        }

        /* Correct Prediction Highlight */
        .match-row.correct-prediction {
            background-color: #dcfce7 !important; /* Tailwind green-100 */
        }
        .match-row.correct-prediction:hover {
             background-color: #bbf7d0 !important; /* Darker green on hover */
        }
        
        /* Comparison Modal Stat Bar */
        .stat-bar-bg {
            background-color: #f1f5f9;
            height: 6px;
            border-radius: 3px;
            overflow: hidden;
        }
        .stat-bar-fill {
            height: 100%;
            border-radius: 3px;
        }
        
        /* Input focus rings for Control Tab */
        .control-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.875rem;
            transition: all 0.2s;
        }
        .control-input:focus {
            ring: 2px;
            border-color: #1E6FFF;
            outline: none;
            box-shadow: 0 0 0 3px rgba(30, 111, 255, 0.1);
        }
    </style>
</head>
<body class="text-slate-800 font-sans antialiased min-h-screen flex flex-col">

    <!-- Header with Gradient -->
    <header class="bg-gradient-to-r from-navy-900 via-[#1E6FFF] to-[#10b981]/90 text-white shadow-xl z-20 sticky top-0">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-20 py-3">
                <!-- Logo -->
                <div class="flex items-center space-x-3">
                    <div class="bg-white/10 p-2.5 rounded-xl shadow-lg backdrop-blur-sm border border-white/20">
                        <i class="fa-solid fa-chart-simple text-white text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold tracking-wide leading-tight text-white drop-shadow-sm">MATCH<span class="text-[#10b981]">ANALYTICS</span></h1>
                        <p class="text-[10px] text-blue-100 tracking-wider uppercase font-medium opacity-80">Professional Intelligence</p>
                    </div>
                </div>

                <!-- Navigation Tabs (Pill Container) -->
                <div class="flex space-x-1 bg-navy-900/60 shadow-inner p-1.5 rounded-full backdrop-blur-md border border-white/10 overflow-x-auto max-w-[60vw]">
                    <button id="tabAll" class="nav-tab active px-4 py-2 rounded-full text-xs sm:text-sm font-semibold flex items-center gap-2" onclick="switchTab('all')">
                        <i class="fa-solid fa-layer-group opacity-90"></i> All Matches
                    </button>
                    <button id="tabTop" class="nav-tab inactive text-gray-400 px-4 py-2 rounded-full text-xs sm:text-sm font-semibold flex items-center gap-2" onclick="switchTab('top')">
                        <i class="fa-solid fa-star text-brand-gold"></i> Top Matches
                    </button>
                     <button id="tabMatchesControl" class="nav-tab inactive text-gray-400 px-4 py-2 rounded-full text-xs sm:text-sm font-semibold flex items-center gap-2" onclick="switchTab('matches_control')">
                        <i class="fa-solid fa-filter-circle-dollar text-orange-400"></i> Matches Control
                    </button>
                    <button id="tabAnalytics" class="nav-tab inactive text-gray-400 px-4 py-2 rounded-full text-xs sm:text-sm font-semibold flex items-center gap-2" onclick="switchTab('analytics')">
                        <i class="fa-solid fa-chart-pie opacity-80"></i> Analytics
                    </button>
                    <button id="tabControl" class="nav-tab inactive text-gray-400 px-4 py-2 rounded-full text-xs sm:text-sm font-semibold flex items-center gap-2" onclick="switchTab('control_panel')">
                        <i class="fa-solid fa-sliders text-cyan-400"></i> Control
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow max-w-7xl w-full mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-8">

        <!-- KPI Cards Section (Visible on Dashboard tabs) -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-4" id="analyticsCards">
            <!-- Total Matches -->
            <div class="kpi-card bg-white p-4 rounded-xl shadow-sm border-l-4 border-brand-blue flex flex-col justify-between relative overflow-hidden h-28">
                <div class="relative z-10">
                    <p class="text-[10px] text-gray-400 uppercase font-semibold tracking-wider mb-1">Total Matches</p>
                    <p class="text-2xl font-bold text-navy-900" id="statTotal">-</p>
                </div>
                <div class="text-brand-blue opacity-10 text-4xl absolute right-2 bottom-2">
                    <i class="fa-solid fa-layer-group"></i>
                </div>
            </div>

            <!-- Total Wins -->
            <div class="kpi-card bg-white p-4 rounded-xl shadow-sm border-l-4 border-brand-green flex flex-col justify-between relative overflow-hidden h-28">
                <div class="relative z-10">
                    <p class="text-[10px] text-gray-400 uppercase font-semibold tracking-wider mb-1">Total Wins</p>
                    <p class="text-2xl font-bold text-navy-900" id="statWins">-</p>
                </div>
                <div class="text-brand-green opacity-10 text-4xl absolute right-2 bottom-2">
                    <i class="fa-solid fa-trophy"></i>
                </div>
            </div>

            <!-- Win Rate -->
            <div class="kpi-card bg-white p-4 rounded-xl shadow-sm border-l-4 border-indigo-500 flex flex-col justify-between relative overflow-hidden h-28">
                <div class="relative z-10">
                    <p class="text-[10px] text-gray-400 uppercase font-semibold tracking-wider mb-1">Win Rate</p>
                    <p class="text-2xl font-bold text-navy-900" id="statRate">-</p>
                </div>
                <div class="text-indigo-500 opacity-10 text-4xl absolute right-2 bottom-2">
                    <i class="fa-solid fa-chart-line"></i>
                </div>
            </div>

            <!-- Upcoming -->
            <div class="kpi-card bg-white p-4 rounded-xl shadow-sm border-l-4 border-brand-orange flex flex-col justify-between relative overflow-hidden h-28">
                <div class="relative z-10">
                    <p class="text-[10px] text-gray-400 uppercase font-semibold tracking-wider mb-1">Upcoming</p>
                    <p class="text-2xl font-bold text-navy-900" id="statUpcoming">-</p>
                </div>
                <div class="text-brand-orange opacity-10 text-4xl absolute right-2 bottom-2">
                    <i class="fa-regular fa-clock"></i>
                </div>
            </div>

            <!-- Net Revenue (New) -->
            <div class="kpi-card bg-white p-4 rounded-xl shadow-sm border-l-4 border-emerald-500 flex flex-col justify-between relative overflow-hidden h-28">
                <div class="relative z-10">
                    <p class="text-[10px] text-gray-400 uppercase font-semibold tracking-wider mb-1">Net Revenue</p>
                    <p class="text-2xl font-bold text-emerald-600" id="statRevenue">-</p>
                </div>
                <div class="text-emerald-500 opacity-10 text-4xl absolute right-2 bottom-2">
                    <i class="fa-solid fa-sack-dollar"></i>
                </div>
            </div>

            <!-- Total Odds (New) -->
            <div class="kpi-card bg-white p-4 rounded-xl shadow-sm border-l-4 border-purple-500 flex flex-col justify-between relative overflow-hidden h-28">
                <div class="relative z-10">
                    <p class="text-[10px] text-gray-400 uppercase font-semibold tracking-wider mb-1">Total Odds</p>
                    <p class="text-2xl font-bold text-purple-600 truncate" id="statTotalOdds">-</p>
                </div>
                <div class="text-purple-500 opacity-10 text-4xl absolute right-2 bottom-2">
                    <i class="fa-solid fa-calculator"></i>
                </div>
            </div>
        </div>

        <!-- Shared Filter Section (Hidden on Control Panels) -->
        <div id="mainFiltersSection" class="bg-white p-5 rounded-xl shadow-sm border border-gray-100">
            <!-- Header Row: Title, Search, Export -->
            <div class="flex flex-col lg:flex-row gap-5 justify-between items-end lg:items-center mb-5 border-b border-gray-100 pb-5">
                <div class="flex items-center gap-3">
                    <div class="bg-navy-900 p-1.5 rounded text-white"><i class="fa-solid fa-filter text-xs"></i></div>
                    <h2 class="text-lg font-bold text-navy-900">Filter Matches</h2>
                </div>
                <div class="flex gap-3 w-full lg:w-auto">
                    <div class="relative flex-1 lg:w-64">
                        <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-xs"></i>
                        <input type="text" id="searchInput" placeholder="Search Teams..." class="w-full pl-9 pr-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-brand-blue focus:border-transparent text-sm transition-all hover:border-gray-300">
                    </div>
                    <button onclick="toggleExport()" class="bg-white border border-brand-gold text-brand-gold px-4 py-2 rounded-lg text-sm font-semibold hover:bg-brand-gold hover:text-white transition shadow-sm flex items-center gap-2">
                        <i class="fa-solid fa-download"></i> Export
                    </button>
                </div>
            </div>
            
            <!-- Filters Grid -->
            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 mb-4">
                <!-- Row 1 of Filters -->
                <div class="relative">
                    <select id="filterDate" class="form-select w-full px-4 py-2.5 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-brand-blue bg-gray-50 text-navy-900 font-medium">
                        <option value="">All Dates</option>
                    </select>
                </div>
                <div class="relative">
                    <select id="filterLeague" class="form-select w-full px-4 py-2.5 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-brand-blue bg-gray-50 text-navy-900 font-medium">
                        <option value="">All Leagues</option>
                    </select>
                </div>
                <!-- NEW FILTERS: HOME/AWAY FORM -->
                <div class="relative">
                    <select id="filterHomeForm" class="form-select w-full px-4 py-2.5 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-brand-blue bg-gray-50 text-navy-900 font-medium">
                        <option value="">Home Form</option>
                    </select>
                </div>
                 <div class="relative">
                    <select id="filterAwayForm" class="form-select w-full px-4 py-2.5 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-brand-blue bg-gray-50 text-navy-900 font-medium">
                        <option value="">Away Form</option>
                    </select>
                </div>

                <div class="relative">
                    <select id="filterPrediction" class="form-select w-full px-4 py-2.5 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-brand-blue bg-gray-50 text-navy-900 font-medium">
                        <option value="">Prediction</option>
                    </select>
                </div>
                <div class="relative">
                    <select id="filterCorrectScore" class="form-select w-full px-4 py-2.5 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-brand-blue bg-gray-50 text-navy-900 font-medium">
                        <option value="">Correct Score</option>
                    </select>
                </div>
                 <div class="flex gap-2 items-center">
                    <input type="number" id="filterConfMin" placeholder="Conf % Min" class="w-1/2 px-3 py-2.5 border border-gray-200 rounded-lg text-sm bg-gray-50 focus:ring-brand-blue">
                    <input type="number" id="filterConfMax" placeholder="Max" class="w-1/2 px-3 py-2.5 border border-gray-200 rounded-lg text-sm bg-gray-50 focus:ring-brand-blue">
                </div>
            </div>

            <!-- Row 2 of Filters (New Ranges) -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 xl:grid-cols-5 gap-4 mb-4">
                 <!-- Model Goals -->
                 <div class="flex flex-col gap-1">
                    <label class="text-[10px] uppercase font-bold text-gray-400">Model Goals</label>
                    <div class="flex gap-2">
                        <input type="number" id="filterGoalsMin" placeholder="Min" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm bg-gray-50 focus:ring-brand-blue">
                        <input type="number" id="filterGoalsMax" placeholder="Max" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm bg-gray-50 focus:ring-brand-blue">
                    </div>
                 </div>
                 <!-- Home Odds -->
                 <div class="flex flex-col gap-1">
                    <label class="text-[10px] uppercase font-bold text-gray-400">Home Odds</label>
                    <div class="flex gap-2">
                        <input type="number" id="filterHomeOddsMin" placeholder="Min" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm bg-gray-50 focus:ring-brand-blue">
                        <input type="number" id="filterHomeOddsMax" placeholder="Max" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm bg-gray-50 focus:ring-brand-blue">
                    </div>
                 </div>
                 <!-- Draw Odds -->
                 <div class="flex flex-col gap-1">
                    <label class="text-[10px] uppercase font-bold text-gray-400">Draw Odds</label>
                    <div class="flex gap-2">
                        <input type="number" id="filterDrawOddsMin" placeholder="Min" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm bg-gray-50 focus:ring-brand-blue">
                        <input type="number" id="filterDrawOddsMax" placeholder="Max" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm bg-gray-50 focus:ring-brand-blue">
                    </div>
                 </div>
                 <!-- Away Odds -->
                 <div class="flex flex-col gap-1">
                    <label class="text-[10px] uppercase font-bold text-gray-400">Away Odds</label>
                    <div class="flex gap-2">
                        <input type="number" id="filterAwayOddsMin" placeholder="Min" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm bg-gray-50 focus:ring-brand-blue">
                        <input type="number" id="filterAwayOddsMax" placeholder="Max" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm bg-gray-50 focus:ring-brand-blue">
                    </div>
                 </div>

                 <!-- Action Buttons -->
                 <div class="flex flex-col gap-2 justify-end h-full">
                    <button onclick="applyFilters()" class="w-full px-4 py-2 bg-brand-green text-white font-medium rounded-lg hover:bg-green-600 transition text-sm flex items-center justify-center gap-2 shadow-md hover:shadow-lg">
                        <i class="fa-solid fa-check"></i> Apply Filters
                    </button>
                    <button onclick="openModal('advancedFiltersModal')" class="w-full px-4 py-2 bg-brand-blue text-white font-medium rounded-lg hover:bg-blue-600 transition text-sm flex items-center justify-center gap-2 shadow-md hover:shadow-lg">
                        <i class="fa-solid fa-sliders"></i> More Filters
                    </button>
                 </div>
            </div>
        </div>

        <!-- VIEW: DASHBOARD TABLE -->
        <div id="viewDashboard" class="transition-opacity duration-300">
            <div id="controlHeader" class="hidden mb-4 bg-orange-50 border border-orange-200 p-4 rounded-xl flex items-center justify-between">
                <div>
                    <h3 class="text-lg font-bold text-navy-900"><i class="fa-solid fa-filter-circle-dollar text-orange-500 mr-2"></i>Matches Control View</h3>
                    <p class="text-sm text-gray-600">Showing matches based on criteria set in the <strong>Control Panel</strong>.</p>
                </div>
                <button onclick="switchTab('control_panel')" class="px-4 py-2 bg-white border border-gray-300 rounded-lg text-sm font-semibold hover:bg-gray-50">
                    Edit Criteria
                </button>
            </div>

            <div class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden flex flex-col" id="tableExportWrapper">
                <div class="table-container overflow-x-auto">
                    <table class="min-w-full" id="matchesTable">
                        <!-- Redesigned Header -->
                        <thead class="bg-gradient-to-r from-navy-900 to-brand-blue text-white border-b-2 border-brand-gold/60">
                            <tr>
                                <th class="px-5 py-5 text-left text-xs font-bold uppercase tracking-wider whitespace-nowrap">Date</th>
                                <th class="px-5 py-5 text-center text-xs font-bold uppercase tracking-wider whitespace-nowrap">Action</th> <!-- Action moved here -->
                                <th class="px-5 py-5 text-left text-xs font-bold uppercase tracking-wider whitespace-nowrap">League</th>
                                <th class="px-5 py-5 text-left text-xs font-bold uppercase tracking-wider whitespace-nowrap">Match</th>
                                <th class="px-5 py-5 text-center text-xs font-bold uppercase tracking-wider whitespace-nowrap">Odds</th>
                                <th class="px-5 py-5 text-center text-xs font-bold uppercase tracking-wider whitespace-nowrap">Conf %</th>
                                <th class="px-5 py-5 text-center text-xs font-bold uppercase tracking-wider whitespace-nowrap">CS</th>
                                <th class="px-5 py-5 text-center text-xs font-bold uppercase tracking-wider whitespace-nowrap">Pred</th>
                                <th class="px-5 py-5 text-center text-xs font-bold uppercase tracking-wider whitespace-nowrap">Goals</th>
                                <th class="px-5 py-5 text-center text-xs font-bold uppercase tracking-wider whitespace-nowrap">Revenue</th> <!-- New Column -->
                                <th class="px-5 py-5 text-center text-xs font-bold uppercase tracking-wider whitespace-nowrap">Result</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white text-sm" id="tableBody">
                            <!-- Rows rendered via JS -->
                        </tbody>
                        <!-- Table Footer -->
                        <tfoot class="bg-gray-50 font-bold text-navy-900">
                            <tr>
                                <td colspan="9" class="px-5 py-4 text-right uppercase text-xs tracking-wider">Total Revenue (Page):</td>
                                <td class="px-5 py-4 text-center" id="footerRevenue">-</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                
                <!-- Loading State -->
                <div id="loadingState" class="hidden p-16 flex flex-col justify-center items-center">
                    <div class="loader mb-4"></div>
                    <p class="text-gray-500 animate-pulse">Analyzing matches...</p>
                </div>

                <!-- Empty State -->
                <div id="emptyState" class="hidden p-16 text-center text-gray-400">
                    <div class="bg-gray-50 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fa-solid fa-magnifying-glass text-2xl text-gray-300"></i>
                    </div>
                    <p class="text-lg font-medium text-gray-600">No matches found</p>
                    <p class="text-sm">Try adjusting your filters to see more results.</p>
                </div>

                <!-- Pagination -->
                <div class="bg-white px-6 py-4 border-t border-gray-100 flex items-center justify-between">
                    <div class="text-xs text-gray-500 font-medium">
                        Showing <span id="pgStart" class="text-navy-900 font-bold">0</span> - <span id="pgEnd" class="text-navy-900 font-bold">0</span> of <span id="pgTotal">0</span> matches
                    </div>
                    <div class="flex gap-2">
                        <button onclick="prevPage()" class="px-4 py-2 bg-white border border-gray-200 rounded-lg text-xs font-semibold text-gray-600 hover:bg-gray-50 hover:border-gray-300 transition disabled:opacity-50">Previous</button>
                        <button onclick="nextPage()" class="px-4 py-2 bg-white border border-gray-200 rounded-lg text-xs font-semibold text-gray-600 hover:bg-gray-50 hover:border-gray-300 transition disabled:opacity-50">Next</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW: ANALYTICS -->
        <div id="viewAnalytics" class="hidden space-y-6 animate-fade-in">
            <!-- Analytics Header -->
            <div class="flex items-center justify-between mb-2">
                <div>
                    <h3 class="text-xl font-bold text-navy-900">Performance Insights</h3>
                    <p class="text-sm text-gray-500">Visual breakdown of model accuracy and trends across <span class="font-bold text-brand-blue">All Matches</span>.</p>
                </div>
                <div class="bg-blue-50 text-brand-blue px-3 py-1 rounded-full text-xs font-bold border border-blue-100">
                    Live Data
                </div>
            </div>

            <!-- Row 1: Trends & Model Effectiveness -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Trend Line Chart -->
                <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100">
                    <h4 class="text-sm font-bold text-gray-700 mb-1">Win Rate Trend (Daily)</h4>
                    <p class="text-xs text-gray-400 mb-4">Consistency over recent match days</p>
                    <div class="h-64">
                        <canvas id="chartTrend"></canvas>
                    </div>
                </div>
                
                <!-- Model Effectiveness Bar Chart -->
                <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100">
                    <h4 class="text-sm font-bold text-gray-700 mb-1">Effectiveness by Prediction Type</h4>
                    <p class="text-xs text-gray-400 mb-4">Win rate comparison across Quick Tips categories</p>
                    <div class="h-64">
                        <canvas id="chartModel"></canvas>
                    </div>
                </div>
            </div>

            <!-- Row 2: Confidence & Outcome Bias -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Confidence Combo Chart -->
                <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 col-span-1 lg:col-span-2">
                    <h4 class="text-sm font-bold text-gray-700 mb-1">Confidence Accuracy</h4>
                    <p class="text-xs text-gray-400 mb-4">Does higher confidence equal higher win rate?</p>
                    <div class="h-64">
                        <canvas id="chartConfidence"></canvas>
                    </div>
                </div>

                <!-- Prediction Bias Doughnut -->
                <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100">
                    <h4 class="text-sm font-bold text-gray-700 mb-1">Prediction Outcome Bias</h4>
                    <p class="text-xs text-gray-400 mb-4">Distribution of H / D / A predictions</p>
                    <div class="h-64 flex justify-center">
                        <canvas id="chartOutcome"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Row 3: Correct Score Heatmap/Bar -->
            <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100">
                <h4 class="text-sm font-bold text-gray-700 mb-1">Correct Score Frequency</h4>
                <p class="text-xs text-gray-400 mb-4">Most predicted scorelines</p>
                <div class="h-64">
                    <canvas id="chartCS"></canvas>
                </div>
            </div>
        </div>

        <!-- VIEW: CONTROL PANEL -->
        <div id="viewControlPanel" class="hidden animate-fade-in">
            <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
                <div class="flex justify-between items-center border-b border-gray-100 pb-4 mb-6">
                    <div>
                        <h2 class="text-xl font-bold text-navy-900"><i class="fa-solid fa-sliders text-cyan-500 mr-2"></i>Control Panel</h2>
                        <p class="text-sm text-gray-500">Configure global criteria for the "Matches Control" view. These settings simulate the Google Sheet control tab.</p>
                    </div>
                    <button onclick="saveControlSettings()" class="bg-brand-blue text-white px-6 py-2.5 rounded-lg shadow-lg hover:bg-blue-600 transition font-bold flex items-center gap-2">
                        <i class="fa-solid fa-floppy-disk"></i> Save & Apply Criteria
                    </button>
                </div>

                <!-- Control Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-x-6 gap-y-6">
                    
                    <!-- Section: Key Metrics -->
                    <div class="col-span-full border-b border-gray-100 pb-2 mb-2"><h3 class="text-sm font-bold text-gray-400 uppercase tracking-widest">Key Metrics</h3></div>
                    
                    <div><label class="block text-xs font-bold text-navy-900 mb-1">Confidence %</label><div class="flex gap-2"><input type="number" id="ctrl_conf_min" placeholder="Min" class="control-input"><input type="number" id="ctrl_conf_max" placeholder="Max" class="control-input"></div></div>
                    <div><label class="block text-xs font-bold text-navy-900 mb-1">Model Goals</label><div class="flex gap-2"><input type="number" id="ctrl_goals_min" placeholder="Min" class="control-input"><input type="number" id="ctrl_goals_max" placeholder="Max" class="control-input"></div></div>
                    <div><label class="block text-xs font-bold text-navy-900 mb-1">Model Prob %</label><div class="flex gap-2"><input type="number" id="ctrl_prob_min" placeholder="Min" class="control-input"><input type="number" id="ctrl_prob_max" placeholder="Max" class="control-input"></div></div>
                    
                    <!-- Section: Odds -->
                    <div class="col-span-full border-b border-gray-100 pb-2 mb-2 mt-2"><h3 class="text-sm font-bold text-gray-400 uppercase tracking-widest">Odds Constraints</h3></div>
                    
                    <div><label class="block text-xs font-bold text-navy-900 mb-1">Home Odds</label><div class="flex gap-2"><input type="number" id="ctrl_home_odds_min" placeholder="Min" class="control-input"><input type="number" id="ctrl_home_odds_max" placeholder="Max" class="control-input"></div></div>
                    <div><label class="block text-xs font-bold text-navy-900 mb-1">Draw Odds</label><div class="flex gap-2"><input type="number" id="ctrl_draw_odds_min" placeholder="Min" class="control-input"><input type="number" id="ctrl_draw_odds_max" placeholder="Max" class="control-input"></div></div>
                    <div><label class="block text-xs font-bold text-navy-900 mb-1">Away Odds</label><div class="flex gap-2"><input type="number" id="ctrl_away_odds_min" placeholder="Min" class="control-input"><input type="number" id="ctrl_away_odds_max" placeholder="Max" class="control-input"></div></div>

                    <!-- Section: Team Stats -->
                    <div class="col-span-full border-b border-gray-100 pb-2 mb-2 mt-2"><h3 class="text-sm font-bold text-gray-400 uppercase tracking-widest">Team Stats & Differentials</h3></div>
                    
                    <div><label class="block text-xs font-bold text-navy-900 mb-1">H2H Home Wins</label><div class="flex gap-2"><input type="number" id="ctrl_h2h_h_min" placeholder="Min" class="control-input"><input type="number" id="ctrl_h2h_h_max" placeholder="Max" class="control-input"></div></div>
                    <div><label class="block text-xs font-bold text-navy-900 mb-1">H2H Away Wins</label><div class="flex gap-2"><input type="number" id="ctrl_h2h_a_min" placeholder="Min" class="control-input"><input type="number" id="ctrl_h2h_a_max" placeholder="Max" class="control-input"></div></div>
                    
                    <div><label class="block text-xs font-bold text-navy-900 mb-1">Home Power</label><div class="flex gap-2"><input type="number" id="ctrl_hp_min" placeholder="Min" class="control-input"><input type="number" id="ctrl_hp_max" placeholder="Max" class="control-input"></div></div>
                    <div><label class="block text-xs font-bold text-navy-900 mb-1">Away Power</label><div class="flex gap-2"><input type="number" id="ctrl_ap_min" placeholder="Min" class="control-input"><input type="number" id="ctrl_ap_max" placeholder="Max" class="control-input"></div></div>
                    
                    <div><label class="block text-xs font-bold text-navy-900 mb-1">Power Difference</label><div class="flex gap-2"><input type="number" id="ctrl_power_diff_min" placeholder="Min" class="control-input"><input type="number" id="ctrl_power_diff_max" placeholder="Max" class="control-input"></div></div>
                    <div><label class="block text-xs font-bold text-navy-900 mb-1">Position Difference</label><div class="flex gap-2"><input type="number" id="ctrl_pos_diff_min" placeholder="Min" class="control-input"><input type="number" id="ctrl_pos_diff_max" placeholder="Max" class="control-input"></div></div>
                    
                    <div><label class="block text-xs font-bold text-navy-900 mb-1">Form Difference</label><div class="flex gap-2"><input type="number" id="ctrl_fd_min" placeholder="Min" class="control-input"><input type="number" id="ctrl_fd_max" placeholder="Max" class="control-input"></div></div>
                    
                    <div><label class="block text-xs font-bold text-navy-900 mb-1">Scored Diff</label><div class="flex gap-2"><input type="number" id="ctrl_sd_min" placeholder="Min" class="control-input"><input type="number" id="ctrl_sd_max" placeholder="Max" class="control-input"></div></div>
                    <div><label class="block text-xs font-bold text-navy-900 mb-1">Conceded Diff</label><div class="flex gap-2"><input type="number" id="ctrl_cd_min" placeholder="Min" class="control-input"><input type="number" id="ctrl_cd_max" placeholder="Max" class="control-input"></div></div>

                </div>
            </div>
        </div>

    </main>

    <!-- Advanced Filters Modal -->
    <div id="advancedFiltersModal" class="fixed inset-0 bg-navy-900/50 backdrop-blur-sm hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full mx-auto my-8 border border-gray-200 flex flex-col max-h-[90vh]">
            <div class="p-6 border-b border-gray-100 flex justify-between items-center bg-gray-50 rounded-t-xl shrink-0">
                <div>
                    <h3 class="text-lg font-bold text-navy-900">Advanced Filters</h3>
                    <p class="text-xs text-gray-500">Refine your search with granular metrics</p>
                </div>
                <button onclick="closeModal('advancedFiltersModal')" class="text-gray-400 hover:text-red-500 transition"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="p-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-6 gap-y-4 overflow-y-auto">
                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">H2H Home Wins</label><div class="flex gap-2"><input type="number" id="af_h2h_h_min" placeholder="Min" class="w-full border border-gray-200 p-2 rounded text-sm focus:ring-brand-blue"><input type="number" id="af_h2h_h_max" placeholder="Max" class="w-full border border-gray-200 p-2 rounded text-sm focus:ring-brand-blue"></div></div>
                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">H2H Away Wins</label><div class="flex gap-2"><input type="number" id="af_h2h_a_min" placeholder="Min" class="w-full border border-gray-200 p-2 rounded text-sm focus:ring-brand-blue"><input type="number" id="af_h2h_a_max" placeholder="Max" class="w-full border border-gray-200 p-2 rounded text-sm focus:ring-brand-blue"></div></div>
                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Home Power</label><div class="flex gap-2"><input type="number" id="af_hp_min" placeholder="Min" class="w-full border border-gray-200 p-2 rounded text-sm focus:ring-brand-blue"><input type="number" id="af_hp_max" placeholder="Max" class="w-full border border-gray-200 p-2 rounded text-sm focus:ring-brand-blue"></div></div>
                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Away Power</label><div class="flex gap-2"><input type="number" id="af_ap_min" placeholder="Min" class="w-full border border-gray-200 p-2 rounded text-sm focus:ring-brand-blue"><input type="number" id="af_ap_max" placeholder="Max" class="w-full border border-gray-200 p-2 rounded text-sm focus:ring-brand-blue"></div></div>
                
                <!-- NEW FILTERS IN MODAL -->
                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Power Difference</label><div class="flex gap-2"><input type="number" id="af_power_diff_min" placeholder="Min" class="w-full border border-gray-200 p-2 rounded text-sm focus:ring-brand-blue"><input type="number" id="af_power_diff_max" placeholder="Max" class="w-full border border-gray-200 p-2 rounded text-sm focus:ring-brand-blue"></div></div>
                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Position Difference</label><div class="flex gap-2"><input type="number" id="af_pos_diff_min" placeholder="Min" class="w-full border border-gray-200 p-2 rounded text-sm focus:ring-brand-blue"><input type="number" id="af_pos_diff_max" placeholder="Max" class="w-full border border-gray-200 p-2 rounded text-sm focus:ring-brand-blue"></div></div>
                <!-- END NEW -->

                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Form Diff</label><div class="flex gap-2"><input type="number" id="af_fd_min" placeholder="Min" class="w-full border border-gray-200 p-2 rounded text-sm focus:ring-brand-blue"><input type="number" id="af_fd_max" placeholder="Max" class="w-full border border-gray-200 p-2 rounded text-sm focus:ring-brand-blue"></div></div>
                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Model Prob %</label><div class="flex gap-2"><input type="number" id="af_mp_min" placeholder="Min" class="w-full border border-gray-200 p-2 rounded text-sm focus:ring-brand-blue"><input type="number" id="af_mp_max" placeholder="Max" class="w-full border border-gray-200 p-2 rounded text-sm focus:ring-brand-blue"></div></div>
                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Scored Diff</label><div class="flex gap-2"><input type="number" id="af_sd_min" placeholder="Min" class="w-full border border-gray-200 p-2 rounded text-sm focus:ring-brand-blue"><input type="number" id="af_sd_max" placeholder="Max" class="w-full border border-gray-200 p-2 rounded text-sm focus:ring-brand-blue"></div></div>
                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Conceded Diff</label><div class="flex gap-2"><input type="number" id="af_cd_min" placeholder="Min" class="w-full border border-gray-200 p-2 rounded text-sm focus:ring-brand-blue"><input type="number" id="af_cd_max" placeholder="Max" class="w-full border border-gray-200 p-2 rounded text-sm focus:ring-brand-blue"></div></div>
            </div>
            <div class="p-6 bg-gray-50 rounded-b-xl flex justify-end gap-3 border-t border-gray-100 shrink-0">
                <button onclick="clearAdvancedFilters()" class="px-5 py-2.5 bg-white border border-gray-300 rounded-lg text-sm text-gray-700 hover:bg-gray-100 font-medium transition">Reset</button>
                <button onclick="applyAdvancedFilters()" class="px-5 py-2.5 bg-brand-blue text-white rounded-lg text-sm font-medium hover:bg-blue-600 shadow-md hover:shadow-lg transition">Apply Filters</button>
            </div>
        </div>
    </div>

    <!-- Match Details Modal -->
    <div id="matchDetailsModal" class="fixed inset-0 bg-navy-900/80 backdrop-blur-sm hidden items-center justify-center z-50 p-4">
        <!-- Max-width reduced from 5xl to 3xl for compactness -->
        <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full mx-auto overflow-hidden transform transition-all border border-gray-600 max-h-[95vh] flex flex-col">
            <!-- Modal Header -->
            <div class="bg-gradient-to-r from-navy-900 to-[#1E6FFF] text-white p-4 relative shrink-0">
                <button onclick="closeModal('matchDetailsModal')" class="absolute top-3 right-3 text-white/70 hover:text-white transition z-20"><i class="fa-solid fa-xmark text-xl"></i></button>
                <div class="text-center relative z-10">
                    <div class="flex justify-center items-center gap-2 mb-1">
                        <span class="text-[10px] font-bold text-brand-gold uppercase tracking-widest bg-black/20 px-2 py-0.5 rounded" id="md_league">PREMIER LEAGUE</span>
                        <span class="text-[10px] font-medium text-blue-100" id="md_date">2023-10-15</span>
                    </div>
                    
                    <div class="flex items-center justify-center gap-4 mt-2">
                        <div class="text-right w-5/12">
                            <h2 class="text-lg font-bold leading-tight truncate" id="md_home">Home Team</h2>
                        </div>
                        <div class="bg-white/10 backdrop-blur-md px-3 py-1 rounded-lg border border-white/20 shadow-lg">
                            <span class="text-xl font-mono font-bold text-white" id="md_score">VS</span>
                        </div>
                        <div class="text-left w-5/12">
                            <h2 class="text-lg font-bold leading-tight truncate" id="md_away">Away Team</h2>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Body: Scrollable Content -->
            <div class="p-4 bg-gray-50 overflow-y-auto flex-grow">
                <div class="space-y-4">
                    
                    <!-- 1. Team Stats Grid (Side-by-Side) -->
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-3">
                         <div class="flex items-center justify-center mb-2">
                             <div class="h-px bg-gray-200 flex-1"></div>
                             <span class="px-2 text-[10px] font-bold text-gray-400 uppercase tracking-widest">Team Stats</span>
                             <div class="h-px bg-gray-200 flex-1"></div>
                         </div>
                         <!-- Headers -->
                         <div class="grid grid-cols-3 gap-2 text-[10px] font-bold text-gray-400 uppercase text-center mb-1">
                            <div class="text-right pr-2">Home</div>
                            <div>Metric</div>
                            <div class="text-left pl-2">Away</div>
                         </div>
                         
                         <!-- Row: Form -->
                         <div class="grid grid-cols-3 gap-2 items-center py-1 border-b border-gray-50">
                             <div class="text-right font-bold text-navy-900 pr-2" id="md_h_form">-</div>
                             <div class="text-center text-xs text-brand-blue font-medium">Form</div>
                             <div class="text-left font-bold text-navy-900 pl-2" id="md_a_form">-</div>
                         </div>
                         <!-- Row: Position -->
                         <div class="grid grid-cols-3 gap-2 items-center py-1 border-b border-gray-50">
                             <div class="text-right font-bold text-navy-900 pr-2" id="md_h_pos">-</div>
                             <div class="text-center text-xs text-brand-blue font-medium">Position</div>
                             <div class="text-left font-bold text-navy-900 pl-2" id="md_a_pos">-</div>
                         </div>
                         <!-- Row: Power -->
                         <div class="grid grid-cols-3 gap-2 items-center py-1">
                             <div class="text-right font-bold text-navy-900 pr-2" id="md_h_power">-</div>
                             <div class="text-center text-xs text-brand-blue font-medium">Power</div>
                             <div class="text-left font-bold text-navy-900 pl-2" id="md_a_power">-</div>
                         </div>
                    </div>

                    <!-- 2. Scoring & H2H (Grid Layout) -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Scoring Metrics -->
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-3">
                            <div class="text-center text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-2">Scoring Averages</div>
                            <div class="space-y-2">
                                <div class="flex justify-between items-center text-sm">
                                    <span class="font-bold text-brand-green" id="md_h_sc_avg">-</span>
                                    <span class="text-[10px] text-gray-500 uppercase">Scored</span>
                                    <span class="font-bold text-brand-green" id="md_a_sc_avg">-</span>
                                </div>
                                <div class="flex justify-between items-center text-sm">
                                    <span class="font-bold text-red-500" id="md_h_con_avg">-</span>
                                    <span class="text-[10px] text-gray-500 uppercase">Conceded</span>
                                    <span class="font-bold text-red-500" id="md_a_con_avg">-</span>
                                </div>
                            </div>
                        </div>

                        <!-- H2H History -->
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-3">
                            <div class="text-center text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-2">Head-to-Head</div>
                            <div class="flex justify-between items-center px-2 mb-1">
                                <div class="text-center">
                                    <div class="text-lg font-black text-navy-900" id="md_h2h_h">0</div>
                                    <div class="text-[9px] text-gray-400 uppercase">Wins</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-base font-bold text-gray-400" id="md_h2h_d">0</div>
                                    <div class="text-[9px] text-gray-300 uppercase">Draws</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-lg font-black text-navy-900" id="md_h2h_a">0</div>
                                    <div class="text-[9px] text-gray-400 uppercase">Wins</div>
                                </div>
                            </div>
                            <!-- Mini Bar -->
                            <div class="flex rounded-full overflow-hidden h-2 bg-gray-100 mx-1">
                                <div id="bar_h2h_h" class="bg-brand-blue h-full" style="width: 33%"></div>
                                <div id="bar_h2h_d" class="bg-gray-300 h-full" style="width: 33%"></div>
                                <div id="bar_h2h_a" class="bg-navy-900 h-full" style="width: 34%"></div>
                            </div>
                        </div>
                    </div>

                    <!-- 3. Model Intelligence -->
                    <div class="bg-gradient-to-br from-navy-900 to-brand-blue rounded-lg shadow-md p-4 text-white relative overflow-hidden">
                        <div class="absolute top-0 right-0 opacity-5 text-8xl transform translate-x-4 -translate-y-4"><i class="fa-solid fa-brain"></i></div>
                        <div class="relative z-10 grid grid-cols-3 gap-4 text-center items-center">
                            <div>
                                <div class="text-[9px] text-blue-200 uppercase font-bold tracking-widest mb-0.5">Model Goals</div>
                                <div class="text-xl font-black text-white" id="md_model_goals">-</div>
                            </div>
                            <div class="bg-white/10 rounded-lg p-2 border border-white/20">
                                <div class="text-[9px] text-brand-gold uppercase font-bold tracking-widest mb-0.5">Prediction</div>
                                <div class="text-2xl font-black text-white leading-none mb-1" id="md_prediction">-</div>
                                <div class="text-[10px] font-bold text-blue-100" id="md_prob">Prob: -%</div>
                            </div>
                            <div>
                                <div class="text-[9px] text-blue-200 uppercase font-bold tracking-widest mb-0.5">Correct Score</div>
                                <div class="text-xl font-black text-white" id="md_cs">-</div>
                            </div>
                        </div>
                    </div>

                    <!-- 4. Differentials (Compact Grid) -->
                    <div>
                         <div class="flex items-center justify-center mb-2">
                             <div class="h-px bg-gray-200 flex-1"></div>
                             <span class="px-2 text-[10px] font-bold text-gray-400 uppercase tracking-widest">Key Differentials</span>
                             <div class="h-px bg-gray-200 flex-1"></div>
                         </div>
                        <div class="grid grid-cols-3 gap-2">
                            <div class="bg-white border border-gray-100 p-2 rounded text-center shadow-sm">
                                <span class="block text-[9px] text-gray-400 font-bold uppercase">Power Diff</span>
                                <span class="font-bold text-sm text-navy-900" id="md_diff_power">-</span>
                            </div>
                            <div class="bg-white border border-gray-100 p-2 rounded text-center shadow-sm">
                                <span class="block text-[9px] text-gray-400 font-bold uppercase">Form Diff</span>
                                <span class="font-bold text-sm text-navy-900" id="md_diff_form">-</span>
                            </div>
                            <div class="bg-white border border-gray-100 p-2 rounded text-center shadow-sm">
                                <span class="block text-[9px] text-gray-400 font-bold uppercase">Pos Diff</span>
                                <span class="font-bold text-sm text-navy-900" id="md_diff_pos">-</span>
                            </div>
                            <div class="bg-white border border-gray-100 p-2 rounded text-center shadow-sm">
                                <span class="block text-[9px] text-gray-400 font-bold uppercase">Scored Diff</span>
                                <span class="font-bold text-sm text-navy-900" id="md_diff_scored">-</span>
                            </div>
                            <div class="bg-white border border-gray-100 p-2 rounded text-center shadow-sm">
                                <span class="block text-[9px] text-gray-400 font-bold uppercase">Conceded Diff</span>
                                <span class="font-bold text-sm text-navy-900" id="md_diff_conceded">-</span>
                            </div>
                            <div class="bg-white border border-gray-100 p-2 rounded text-center shadow-sm">
                                <span class="block text-[9px] text-gray-400 font-bold uppercase">H2H Diff</span>
                                <span class="font-bold text-sm text-navy-900" id="md_diff_h2h">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Footer: Buttons -->
            <div class="p-4 bg-white border-t border-gray-100 shrink-0 flex gap-3">
                 <a href="#" id="md_link" target="_blank" class="flex-1 text-center bg-white text-navy-900 border border-gray-300 py-2.5 rounded-lg text-sm font-bold hover:bg-gray-50 transition flex items-center justify-center gap-2 group">
                    <span>Match Source</span>
                    <i class="fa-solid fa-arrow-up-right-from-square text-xs group-hover:translate-x-1 transition-transform"></i>
                </a>
                <button onclick="closeModal('matchDetailsModal')" class="flex-1 bg-navy-900 text-white py-2.5 rounded-lg text-sm font-bold hover:bg-brand-blue transition shadow-md">
                    Close Details
                </button>
            </div>
        </div>
    </div>

    <!-- JavaScript Logic -->
    <script>
        // --- Configuration & State ---
        const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS4skYgtxtfHuZElx4Mrx2n4NC0keZGjsKxgZNHOpPGrkVy2j_5GQWmyNlQu1y5TAjQKfDHAiBVknfi/pub?gid=1663545554&single=true&output=csv';
        
        let allData = [];
        let filteredData = [];
        let currentPage = 1;
        const rowsPerPage = 30;
        let currentTab = 'all'; // 'all', 'top', 'matches_control', 'analytics', 'control_panel'
        
        // Control Tab Settings Object
        let controlConfig = JSON.parse(localStorage.getItem('match_analytics_control_config')) || {};

        // Chart Instances
        let charts = {};

        // DOM Elements
        const tableBody = document.getElementById('tableBody');
        const loadingState = document.getElementById('loadingState');
        const emptyState = document.getElementById('emptyState');
        
        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            fetchData();
            setupEventListeners();
            loadControlSettings(); // Load saved control settings into inputs
        });

        // --- Data Fetching & Parsing ---
        async function fetchData() {
            loadingState.classList.remove('hidden');
            tableBody.innerHTML = '';
            
            try {
                const response = await fetch(SHEET_CSV_URL);
                const csvText = await response.text();
                allData = parseCSV(csvText);
                
                // Populate Filter Dropdowns
                populateDropdown('filterDate', 'Date');
                populateDropdown('filterLeague', 'League'); 
                populateDropdown('filterHomeForm', 'Home Form'); // New
                populateDropdown('filterAwayForm', 'Away Form'); // New
                populateDropdown('filterCorrectScore', 'Correct Score');
                populateDropdown('filterPrediction', 'Model Prediction');

                applyFilters(); // Initial render
            } catch (error) {
                console.error('Error fetching data:', error);
                loadingState.innerHTML = '<p class="text-red-500 font-bold">Error loading data. Please refresh.</p>';
            } finally {
                loadingState.classList.add('hidden');
            }
        }

        function parseCSV(text) {
            const rows = [];
            let row = [];
            let inQuote = false;
            let currentCell = '';
            
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                const nextChar = text[i+1];
                
                if (char === '"') {
                    if (inQuote && nextChar === '"') {
                        currentCell += '"';
                        i++; 
                    } else {
                        inQuote = !inQuote;
                    }
                } else if (char === ',' && !inQuote) {
                    row.push(currentCell.trim());
                    currentCell = '';
                } else if ((char === '\r' || char === '\n') && !inQuote) {
                    if (currentCell || row.length > 0) row.push(currentCell.trim());
                    if (row.length > 0) rows.push(row);
                    row = [];
                    currentCell = '';
                    if (char === '\r' && nextChar === '\n') i++;
                } else {
                    currentCell += char;
                }
            }
            if (currentCell || row.length > 0) {
                row.push(currentCell.trim());
                rows.push(row);
            }

            const headers = rows[0];
            const rawData = rows.slice(1).map(r => {
                const obj = {};
                headers.forEach((h, index) => {
                    obj[h] = r[index] || '';
                });
                return obj;
            });

            // Remove duplicates based on MatchKey
            const uniqueData = [];
            const seenKeys = new Set();
            
            rawData.forEach(item => {
                const key = item['MatchKey'];
                // Only process if we have a key, if duplicate skip
                if (key && !seenKeys.has(key)) {
                    seenKeys.add(key);
                    uniqueData.push(item);
                } else if (!key) {
                    // If no MatchKey, keep it (fallback)
                    uniqueData.push(item);
                }
            });

            return uniqueData;
        }

        // --- Filtering Logic ---
        function setupEventListeners() {
            let debounceTimer;
            // Search input
            document.getElementById('searchInput').addEventListener('input', (e) => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => applyFilters(), 300);
            });

            // Dropdowns
            ['filterDate', 'filterLeague', 'filterHomeForm', 'filterAwayForm', 'filterCorrectScore', 'filterPrediction'].forEach(id => {
                document.getElementById(id).addEventListener('change', () => applyFilters());
            });

            // Range inputs - Enter key triggers
            const inputs = document.querySelectorAll('#mainFiltersSection input[type="number"]');
            inputs.forEach(input => {
                input.addEventListener('keydown', (e) => {
                    if(e.key === 'Enter') applyFilters();
                });
            });
        }

        function switchTab(tab) {
            currentTab = tab;
            
            // Remove active class from all tabs
            document.querySelectorAll('.nav-tab').forEach(btn => {
                btn.classList.remove('active', 'text-white');
                btn.classList.add('inactive', 'text-gray-400');
            });

            // Activate current tab button
            let activeBtnId;
            if (tab === 'all') activeBtnId = 'tabAll';
            else if (tab === 'top') activeBtnId = 'tabTop';
            else if (tab === 'matches_control') activeBtnId = 'tabMatchesControl';
            else if (tab === 'analytics') activeBtnId = 'tabAnalytics';
            else if (tab === 'control_panel') activeBtnId = 'tabControl';
            
            const activeBtn = document.getElementById(activeBtnId);
            if(activeBtn) {
                activeBtn.classList.remove('inactive', 'text-gray-400');
                activeBtn.classList.add('active', 'text-white');
            }

            // View Switching
            const viewDashboard = document.getElementById('viewDashboard');
            const viewAnalytics = document.getElementById('viewAnalytics');
            const viewControlPanel = document.getElementById('viewControlPanel');
            const mainFilters = document.getElementById('mainFiltersSection');
            const controlHeader = document.getElementById('controlHeader');

            // Hide all first
            viewDashboard.classList.add('hidden');
            viewAnalytics.classList.add('hidden');
            viewControlPanel.classList.add('hidden');
            mainFilters.classList.remove('hidden'); // Default show
            controlHeader.classList.add('hidden');

            if (tab === 'analytics') {
                viewAnalytics.classList.remove('hidden');
                applyFilters(); // Re-run to update charts
            } else if (tab === 'control_panel') {
                viewControlPanel.classList.remove('hidden');
                mainFilters.classList.add('hidden'); // Hide main filters here
            } else if (tab === 'matches_control') {
                viewDashboard.classList.remove('hidden');
                mainFilters.classList.add('hidden'); // Hide main filters here
                controlHeader.classList.remove('hidden');
                applyFilters(); // Will use controlConfig
            } else {
                // All or Top
                viewDashboard.classList.remove('hidden');
                applyFilters();
            }
        }

        function applyFilters() {
            // Determine source of criteria
            let criteria = {};
            
            if (currentTab === 'matches_control') {
                // Use stored Control Panel settings
                criteria = { ...controlConfig, isControlView: true };
            } else {
                // Use Standard UI Filters
                criteria = {
                    searchTerm: document.getElementById('searchInput').value.toLowerCase(),
                    fDate: document.getElementById('filterDate').value,
                    fLeague: document.getElementById('filterLeague').value,
                    fHomeForm: document.getElementById('filterHomeForm').value,
                    fAwayForm: document.getElementById('filterAwayForm').value,
                    fCS: document.getElementById('filterCorrectScore').value,
                    fPred: document.getElementById('filterPrediction').value,
                    fConfMin: parseFloat(document.getElementById('filterConfMin').value) || 0,
                    fConfMax: parseFloat(document.getElementById('filterConfMax').value) || 100,
                    fGoalsMin: parseFloat(document.getElementById('filterGoalsMin').value) || -Infinity,
                    fGoalsMax: parseFloat(document.getElementById('filterGoalsMax').value) || Infinity,
                    fHomeOddsMin: parseFloat(document.getElementById('filterHomeOddsMin').value) || -Infinity,
                    fHomeOddsMax: parseFloat(document.getElementById('filterHomeOddsMax').value) || Infinity,
                    fDrawOddsMin: parseFloat(document.getElementById('filterDrawOddsMin').value) || -Infinity,
                    fDrawOddsMax: parseFloat(document.getElementById('filterDrawOddsMax').value) || Infinity,
                    fAwayOddsMin: parseFloat(document.getElementById('filterAwayOddsMin').value) || -Infinity,
                    fAwayOddsMax: parseFloat(document.getElementById('filterAwayOddsMax').value) || Infinity,
                    // Advanced modal vars
                    af_h2h_h_min: parseFloat(document.getElementById('af_h2h_h_min').value) || -Infinity,
                    af_h2h_h_max: parseFloat(document.getElementById('af_h2h_h_max').value) || Infinity,
                    af_h2h_a_min: parseFloat(document.getElementById('af_h2h_a_min').value) || -Infinity,
                    af_h2h_a_max: parseFloat(document.getElementById('af_h2h_a_max').value) || Infinity,
                    af_hp_min: parseFloat(document.getElementById('af_hp_min').value) || -Infinity,
                    af_hp_max: parseFloat(document.getElementById('af_hp_max').value) || Infinity,
                    af_ap_min: parseFloat(document.getElementById('af_ap_min').value) || -Infinity,
                    af_ap_max: parseFloat(document.getElementById('af_ap_max').value) || Infinity,
                    af_fd_min: parseFloat(document.getElementById('af_fd_min').value) || -Infinity,
                    af_fd_max: parseFloat(document.getElementById('af_fd_max').value) || Infinity,
                    af_mp_min: parseFloat(document.getElementById('af_mp_min').value) || -Infinity,
                    af_mp_max: parseFloat(document.getElementById('af_mp_max').value) || Infinity,
                    af_sd_min: parseFloat(document.getElementById('af_sd_min').value) || -Infinity,
                    af_sd_max: parseFloat(document.getElementById('af_sd_max').value) || Infinity,
                    af_cd_min: parseFloat(document.getElementById('af_cd_min').value) || -Infinity,
                    af_cd_max: parseFloat(document.getElementById('af_cd_max').value) || Infinity,
                    // New Advanced
                    af_power_diff_min: parseFloat(document.getElementById('af_power_diff_min').value) || -Infinity,
                    af_power_diff_max: parseFloat(document.getElementById('af_power_diff_max').value) || Infinity,
                    af_pos_diff_min: parseFloat(document.getElementById('af_pos_diff_min').value) || -Infinity,
                    af_pos_diff_max: parseFloat(document.getElementById('af_pos_diff_max').value) || Infinity
                };
            }
            
            filteredData = allData.filter(row => {
                // 1. Tab Specific First
                if (currentTab === 'top' && row['Quick Tip'] !== 'Perfect') return false;

                // 2. Logic Branch based on Mode
                if (criteria.isControlView) {
                    // CONTROL VIEW FILTERING
                    const c = criteria;
                    
                    // Confidence
                    const conf = parseFloat(row['Confidence %']) || 0;
                    if (conf < (c.ctrl_conf_min || 0) || conf > (c.ctrl_conf_max || 100)) return false;
                    
                    // Goals
                    const goals = parseFloat(row['Model Goals']) || 0;
                    if (goals < (c.ctrl_goals_min || -Infinity) || goals > (c.ctrl_goals_max || Infinity)) return false;
                    
                    // Prob
                    const prob = parseFloat(row['Model Probability %']) || 0;
                    if (prob < (c.ctrl_prob_min || -Infinity) || prob > (c.ctrl_prob_max || Infinity)) return false;
                    
                    // Odds
                    const hOdds = parseFloat(row['Home Odds']) || 0;
                    if (hOdds < (c.ctrl_home_odds_min || -Infinity) || hOdds > (c.ctrl_home_odds_max || Infinity)) return false;
                    const dOdds = parseFloat(row['Draw Odds']) || 0;
                    if (dOdds < (c.ctrl_draw_odds_min || -Infinity) || dOdds > (c.ctrl_draw_odds_max || Infinity)) return false;
                    const aOdds = parseFloat(row['Away Odds']) || 0;
                    if (aOdds < (c.ctrl_away_odds_min || -Infinity) || aOdds > (c.ctrl_away_odds_max || Infinity)) return false;

                    // H2H
                    const h2hH = parseFloat(row['H2H Home Wins']) || 0;
                    if (h2hH < (c.ctrl_h2h_h_min || -Infinity) || h2hH > (c.ctrl_h2h_h_max || Infinity)) return false;
                    const h2hA = parseFloat(row['H2H Away Wins']) || 0;
                    if (h2hA < (c.ctrl_h2h_a_min || -Infinity) || h2hA > (c.ctrl_h2h_a_max || Infinity)) return false;
                    
                    // Power
                    const hp = parseFloat(row['Home Power']) || 0;
                    if (hp < (c.ctrl_hp_min || -Infinity) || hp > (c.ctrl_hp_max || Infinity)) return false;
                    const ap = parseFloat(row['Away Power']) || 0;
                    if (ap < (c.ctrl_ap_min || -Infinity) || ap > (c.ctrl_ap_max || Infinity)) return false;
                    
                    // Diffs
                    const pDiff = parseFloat(row['Power Difference']) || 0;
                    if (pDiff < (c.ctrl_power_diff_min || -Infinity) || pDiff > (c.ctrl_power_diff_max || Infinity)) return false;
                    
                    const posDiff = (parseFloat(row['Home Position']) - parseFloat(row['Away Position']));
                    if (posDiff < (c.ctrl_pos_diff_min || -Infinity) || posDiff > (c.ctrl_pos_diff_max || Infinity)) return false;

                    const fd = parseFloat(row['Form Difference']) || 0;
                    if (fd < (c.ctrl_fd_min || -Infinity) || fd > (c.ctrl_fd_max || Infinity)) return false;
                    
                    const sd = parseFloat(row['Scored Difference']) || 0;
                    if (sd < (c.ctrl_sd_min || -Infinity) || sd > (c.ctrl_sd_max || Infinity)) return false;
                    
                    const cd = parseFloat(row['Conceded Difference']) || 0;
                    if (cd < (c.ctrl_cd_min || -Infinity) || cd > (c.ctrl_cd_max || Infinity)) return false;

                    return true;

                } else {
                    // STANDARD VIEW FILTERING
                    const c = criteria;

                    // Search
                    if (c.searchTerm && !row['Home Team'].toLowerCase().includes(c.searchTerm) && !row['Away Team'].toLowerCase().includes(c.searchTerm)) return false;
                    
                    // Dropdowns
                    if (c.fDate && row['Date'] !== c.fDate) return false;
                    if (c.fLeague && row['League'] !== c.fLeague) return false;
                    if (c.fHomeForm && row['Home Form'] !== c.fHomeForm) return false; // New
                    if (c.fAwayForm && row['Away Form'] !== c.fAwayForm) return false; // New
                    if (c.fCS && row['Correct Score'] !== c.fCS) return false;
                    if (c.fPred && row['Model Prediction'] !== c.fPred) return false;

                    // Ranges (Main)
                    const conf = parseFloat(row['Confidence %']) || 0;
                    if (conf < c.fConfMin || conf > c.fConfMax) return false;

                    const goals = parseFloat(row['Model Goals']) || 0;
                    if (goals < c.fGoalsMin || goals > c.fGoalsMax) return false;

                    const homeOdds = parseFloat(row['Home Odds']) || 0;
                    if (homeOdds < c.fHomeOddsMin || homeOdds > c.fHomeOddsMax) return false;

                    const drawOdds = parseFloat(row['Draw Odds']) || 0;
                    if (drawOdds < c.fDrawOddsMin || drawOdds > c.fDrawOddsMax) return false;

                    const awayOdds = parseFloat(row['Away Odds']) || 0;
                    if (awayOdds < c.fAwayOddsMin || awayOdds > c.fAwayOddsMax) return false;

                    // Ranges (Advanced)
                    const h2hH = parseFloat(row['H2H Home Wins']) || 0;
                    if (h2hH < c.af_h2h_h_min || h2hH > c.af_h2h_h_max) return false;
                    
                    const h2hA = parseFloat(row['H2H Away Wins']) || 0;
                    if (h2hA < c.af_h2h_a_min || h2hA > c.af_h2h_a_max) return false;
                    
                    const hp = parseFloat(row['Home Power']) || 0;
                    if (hp < c.af_hp_min || hp > c.af_hp_max) return false;
                    
                    const ap = parseFloat(row['Away Power']) || 0;
                    if (ap < c.af_ap_min || ap > c.af_ap_max) return false;

                    const fd = parseFloat(row['Form Difference']) || 0;
                    if (fd < c.af_fd_min || fd > c.af_fd_max) return false;
                    
                    const mp = parseFloat(row['Model Probability %']) || 0;
                    if (mp < c.af_mp_min || mp > c.af_mp_max) return false;
                    
                    const sd = parseFloat(row['Scored Difference']) || 0;
                    if (sd < c.af_sd_min || sd > c.af_sd_max) return false;
                    
                    const cd = parseFloat(row['Conceded Difference']) || 0;
                    if (cd < c.af_cd_min || cd > c.af_cd_max) return false;

                    const powerDiff = parseFloat(row['Power Difference']) || 0;
                    if (powerDiff < c.af_power_diff_min || powerDiff > c.af_power_diff_max) return false;

                    const posDiff = (parseFloat(row['Home Position']) - parseFloat(row['Away Position']));
                    if (posDiff < c.af_pos_diff_min || posDiff > c.af_pos_diff_max) return false;

                    return true;
                }
            });

            // Update UI
            updateKPIs();
            if (currentTab === 'analytics') {
                updateCharts();
            } else if (currentTab === 'control_panel') {
                // Do nothing to table
            } else {
                currentPage = 1; 
                renderTable();
            }
        }

        // --- Advanced Filters Functionality ---
        function applyAdvancedFilters() { 
            // Re-trigger applyFilters to read the modal inputs
            applyFilters(); 
            // If we are on dashboard or top tabs, the table will re-render in applyFilters()
            closeModal('advancedFiltersModal');
        }

        function clearAdvancedFilters() {
            document.querySelectorAll('#advancedFiltersModal input').forEach(inp => inp.value = '');
            applyFilters();
        }

        // --- Control Panel Functions ---
        function saveControlSettings() {
            // Read inputs
            controlConfig = {
                ctrl_conf_min: parseFloat(document.getElementById('ctrl_conf_min').value) || -Infinity,
                ctrl_conf_max: parseFloat(document.getElementById('ctrl_conf_max').value) || Infinity,
                ctrl_goals_min: parseFloat(document.getElementById('ctrl_goals_min').value) || -Infinity,
                ctrl_goals_max: parseFloat(document.getElementById('ctrl_goals_max').value) || Infinity,
                ctrl_prob_min: parseFloat(document.getElementById('ctrl_prob_min').value) || -Infinity,
                ctrl_prob_max: parseFloat(document.getElementById('ctrl_prob_max').value) || Infinity,
                
                ctrl_home_odds_min: parseFloat(document.getElementById('ctrl_home_odds_min').value) || -Infinity,
                ctrl_home_odds_max: parseFloat(document.getElementById('ctrl_home_odds_max').value) || Infinity,
                ctrl_draw_odds_min: parseFloat(document.getElementById('ctrl_draw_odds_min').value) || -Infinity,
                ctrl_draw_odds_max: parseFloat(document.getElementById('ctrl_draw_odds_max').value) || Infinity,
                ctrl_away_odds_min: parseFloat(document.getElementById('ctrl_away_odds_min').value) || -Infinity,
                ctrl_away_odds_max: parseFloat(document.getElementById('ctrl_away_odds_max').value) || Infinity,

                ctrl_h2h_h_min: parseFloat(document.getElementById('ctrl_h2h_h_min').value) || -Infinity,
                ctrl_h2h_h_max: parseFloat(document.getElementById('ctrl_h2h_h_max').value) || Infinity,
                ctrl_h2h_a_min: parseFloat(document.getElementById('ctrl_h2h_a_min').value) || -Infinity,
                ctrl_h2h_a_max: parseFloat(document.getElementById('ctrl_h2h_a_max').value) || Infinity,

                ctrl_hp_min: parseFloat(document.getElementById('ctrl_hp_min').value) || -Infinity,
                ctrl_hp_max: parseFloat(document.getElementById('ctrl_hp_max').value) || Infinity,
                ctrl_ap_min: parseFloat(document.getElementById('ctrl_ap_min').value) || -Infinity,
                ctrl_ap_max: parseFloat(document.getElementById('ctrl_ap_max').value) || Infinity,

                ctrl_power_diff_min: parseFloat(document.getElementById('ctrl_power_diff_min').value) || -Infinity,
                ctrl_power_diff_max: parseFloat(document.getElementById('ctrl_power_diff_max').value) || Infinity,
                ctrl_pos_diff_min: parseFloat(document.getElementById('ctrl_pos_diff_min').value) || -Infinity,
                ctrl_pos_diff_max: parseFloat(document.getElementById('ctrl_pos_diff_max').value) || Infinity,

                ctrl_fd_min: parseFloat(document.getElementById('ctrl_fd_min').value) || -Infinity,
                ctrl_fd_max: parseFloat(document.getElementById('ctrl_fd_max').value) || Infinity,
                
                ctrl_sd_min: parseFloat(document.getElementById('ctrl_sd_min').value) || -Infinity,
                ctrl_sd_max: parseFloat(document.getElementById('ctrl_sd_max').value) || Infinity,
                ctrl_cd_min: parseFloat(document.getElementById('ctrl_cd_min').value) || -Infinity,
                ctrl_cd_max: parseFloat(document.getElementById('ctrl_cd_max').value) || Infinity,
            };

            // Save to LocalStorage
            localStorage.setItem('match_analytics_control_config', JSON.stringify(controlConfig));
            
            // Switch tab and render
            switchTab('matches_control');
        }

        function loadControlSettings() {
            // Helper to set value if not +/- Infinity
            const setVal = (id, val) => {
                if (val !== undefined && val !== null && val !== Infinity && val !== -Infinity) {
                    document.getElementById(id).value = val;
                }
            };
            
            const c = controlConfig;
            setVal('ctrl_conf_min', c.ctrl_conf_min); setVal('ctrl_conf_max', c.ctrl_conf_max);
            setVal('ctrl_goals_min', c.ctrl_goals_min); setVal('ctrl_goals_max', c.ctrl_goals_max);
            setVal('ctrl_prob_min', c.ctrl_prob_min); setVal('ctrl_prob_max', c.ctrl_prob_max);
            
            setVal('ctrl_home_odds_min', c.ctrl_home_odds_min); setVal('ctrl_home_odds_max', c.ctrl_home_odds_max);
            setVal('ctrl_draw_odds_min', c.ctrl_draw_odds_min); setVal('ctrl_draw_odds_max', c.ctrl_draw_odds_max);
            setVal('ctrl_away_odds_min', c.ctrl_away_odds_min); setVal('ctrl_away_odds_max', c.ctrl_away_odds_max);

            setVal('ctrl_h2h_h_min', c.ctrl_h2h_h_min); setVal('ctrl_h2h_h_max', c.ctrl_h2h_h_max);
            setVal('ctrl_h2h_a_min', c.ctrl_h2h_a_min); setVal('ctrl_h2h_a_max', c.ctrl_h2h_a_max);
            
            setVal('ctrl_hp_min', c.ctrl_hp_min); setVal('ctrl_hp_max', c.ctrl_hp_max);
            setVal('ctrl_ap_min', c.ctrl_ap_min); setVal('ctrl_ap_max', c.ctrl_ap_max);

            setVal('ctrl_power_diff_min', c.ctrl_power_diff_min); setVal('ctrl_power_diff_max', c.ctrl_power_diff_max);
            setVal('ctrl_pos_diff_min', c.ctrl_pos_diff_min); setVal('ctrl_pos_diff_max', c.ctrl_pos_diff_max);

            setVal('ctrl_fd_min', c.ctrl_fd_min); setVal('ctrl_fd_max', c.ctrl_fd_max);
            setVal('ctrl_sd_min', c.ctrl_sd_min); setVal('ctrl_sd_max', c.ctrl_sd_max);
            setVal('ctrl_cd_min', c.ctrl_cd_min); setVal('ctrl_cd_max', c.ctrl_cd_max);
        }

        // --- Helper: Get Odds for Predicted Result ---
        function getOddsForPrediction(row) {
            const pred = row['Model Prediction'] ? row['Model Prediction'].toLowerCase() : '';
            if (pred === '1' || pred === 'home') return parseFloat(row['Home Odds']) || 1.0;
            if (pred === 'x' || pred === 'draw') return parseFloat(row['Draw Odds']) || 1.0;
            if (pred === '2' || pred === 'away') return parseFloat(row['Away Odds']) || 1.0;
            return 1.0;
        }

        // --- Rendering ---
        function updateKPIs() {
            const total = filteredData.length;
            let wins = 0;
            let upcoming = 0;
            let totalRevenue = 0;
            let totalOdds = 1.0;
            let hasFilteredMatches = total > 0;

            filteredData.forEach(row => {
                const res = row['Match Result'];
                const pred = row['Model Prediction'];
                const odds = getOddsForPrediction(row);
                
                // Accumulate Odds
                totalOdds *= odds;

                if (!res || res === '-' || res === '?') {
                    upcoming++;
                } else if (isPredictionCorrect(res, pred)) {
                    wins++;
                    // Revenue: (Odds * 100) - 100
                    totalRevenue += (odds * 100) - 100;
                } else {
                    // Loss: -100
                    totalRevenue += -100;
                }
            });

            const rate = total > 0 && (total - upcoming) > 0 
                ? ((wins / (total - upcoming)) * 100).toFixed(1) + '%' 
                : '0%';
            
            // Format Total Odds: if massive, use scientific or truncated
            let formattedTotalOdds = totalOdds.toFixed(2);
            if (totalOdds > 10000) formattedTotalOdds = totalOdds.toExponential(2);
            if (!hasFilteredMatches) formattedTotalOdds = "0.00";

            document.getElementById('statTotal').innerText = total;
            document.getElementById('statWins').innerText = wins;
            document.getElementById('statRate').innerText = rate;
            document.getElementById('statUpcoming').innerText = upcoming;
            
            // Revenue Display
            const revEl = document.getElementById('statRevenue');
            revEl.innerText = (totalRevenue >= 0 ? '+' : '') + totalRevenue.toFixed(2);
            revEl.className = `text-2xl font-bold ${totalRevenue >= 0 ? 'text-emerald-600' : 'text-red-500'}`;

            // Total Odds Display
            document.getElementById('statTotalOdds').innerText = formattedTotalOdds;
        }

        function renderTable() {
            const start = (currentPage - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const pageData = filteredData.slice(start, end);

            tableBody.innerHTML = '';
            
            // Calc Page Revenue for Footer
            let pageRevenue = 0;

            if (pageData.length === 0) {
                emptyState.classList.remove('hidden');
                document.getElementById('matchesTable').classList.add('hidden');
            } else {
                emptyState.classList.add('hidden');
                document.getElementById('matchesTable').classList.remove('hidden');
                
                pageData.forEach((row, index) => {
                    const tr = document.createElement('tr');
                    tr.className = "match-row group";
                    
                    const res = row['Match Result'] || '-';
                    const pred = row['Model Prediction'];
                    const isWin = isPredictionCorrect(res, pred);
                    const isUpcoming = (res === '-' || res === '?');
                    const conf = parseFloat(row['Confidence %']) || 0;
                    
                    // Row Background Logic
                    if (isWin && !isUpcoming) {
                        tr.classList.add('correct-prediction');
                    } else {
                        if (index % 2 === 0) {
                            tr.classList.add('bg-blue-50/30');
                        } else {
                            tr.classList.add('bg-green-50/20');
                        }
                    }
                    
                    // Result Badge Logic
                    let predBadge = "";
                    if (!isUpcoming) {
                        if (isWin) {
                            predBadge = `<span class="inline-block w-2 h-2 bg-green-500 rounded-full ml-1" title="Win"></span>`;
                        } else {
                            predBadge = `<span class="inline-block w-2 h-2 bg-red-300 rounded-full ml-1" title="Loss"></span>`;
                        }
                    } else {
                        predBadge = `<span class="inline-block w-2 h-2 bg-orange-400 rounded-full ml-1" title="Upcoming"></span>`;
                    }

                    // Model Goals > 2.5 Badge
                    let goalsDisplay = `<span class="text-gray-500">${row['Model Goals']}</span>`;
                    if (parseFloat(row['Model Goals']) > 2.5) {
                        goalsDisplay = `<span class="bg-green-100 text-green-800 text-[10px] font-bold px-1.5 py-0.5 rounded border border-green-200">${row['Model Goals']}</span>`;
                    }

                    // Confidence Bar Logic
                    let barColorClass = "bg-brand-blue";
                    if (conf > 50) barColorClass = "bg-brand-green";
                    if (conf > 75) barColorClass = "bg-[#10b981]"; 
                    
                    // Revenue Calculation Logic
                    const odds = getOddsForPrediction(row);
                    let revenue = 0;
                    let revenueText = "-";
                    let revenueClass = "text-gray-400"; // default gray
                    
                    if (isUpcoming) {
                        // Show Potential Return (Stake * Odds)
                        revenue = odds * 100;
                        revenueText = revenue.toFixed(2);
                        revenueClass = "text-gray-400 font-medium"; // Gray for potential
                    } else {
                        if (isWin) {
                            // Profit: (Odds * 100) - 100
                            revenue = (odds * 100) - 100;
                            revenueText = "+" + revenue.toFixed(2);
                            revenueClass = "text-emerald-600 font-bold";
                            pageRevenue += revenue;
                        } else {
                            // Loss: -100
                            revenue = -100;
                            revenueText = "-100.00";
                            revenueClass = "text-red-500 font-bold";
                            pageRevenue += revenue;
                        }
                    }


                    tr.innerHTML = `
                        <td class="px-5 py-4 whitespace-nowrap text-navy-900 font-bold">${row['Date']}</td>
                        <td class="px-5 py-4 text-center whitespace-nowrap">
                            <button class="text-navy-900 hover:text-white hover:bg-brand-blue bg-white border border-gray-200 hover:border-brand-blue px-3 py-1.5 rounded-lg transition-all shadow-sm flex items-center justify-center gap-1 mx-auto text-xs font-bold" onclick="viewMatch('${row['MatchKey']}')">
                                <span>View</span> <i class="fa-solid fa-chevron-right text-[10px]"></i>
                            </button>
                        </td>
                        <td class="px-5 py-4 whitespace-nowrap text-xs text-gray-500 font-medium truncate max-w-[120px]" title="${row['League']}">${row['League']}</td>
                        <td class="px-5 py-4 whitespace-nowrap">
                            <div class="flex flex-col">
                                <span class="font-bold text-navy-900 text-sm">${row['Home Team']}</span>
                                <span class="text-xs text-gray-500 font-medium">${row['Away Team']}</span>
                            </div>
                        </td>
                        <td class="px-5 py-4 text-center whitespace-nowrap text-xs text-gray-400 font-mono tracking-tighter">
                            ${row['Home Odds']}|${row['Draw Odds']}|${row['Away Odds']}
                        </td>
                        <td class="px-5 py-4 text-center whitespace-nowrap">
                            <div class="flex items-center gap-2 justify-center">
                                <div class="w-12 bg-gray-200 rounded-full h-1.5 overflow-hidden">
                                    <div class="${barColorClass} h-full rounded-full" style="width: ${conf}%"></div>
                                </div>
                                <span class="text-xs font-bold text-gray-600 w-6 text-left">${conf}</span>
                            </div>
                        </td>
                        <td class="px-5 py-4 text-center whitespace-nowrap text-xs text-navy-900 font-bold opacity-80">${row['Correct Score']}</td>
                        <td class="px-5 py-4 text-center whitespace-nowrap text-sm font-bold text-navy-900">
                           <div class="flex items-center justify-center">
                                <span>${pred}</span>
                                ${predBadge}
                           </div>
                        </td>
                        <td class="px-5 py-4 text-center whitespace-nowrap text-xs">
                            ${goalsDisplay}
                        </td>
                         <td class="px-5 py-4 text-center whitespace-nowrap text-sm ${revenueClass}">
                            ${revenueText}
                        </td>
                        <td class="px-5 py-4 text-center whitespace-nowrap">
                            <span class="font-mono font-bold text-navy-900 bg-white/50 px-2 py-1 rounded text-xs">${res}</span>
                        </td>
                    `;
                    tableBody.appendChild(tr);
                });
            }
            
            // Update Footer Revenue
            const footerEl = document.getElementById('footerRevenue');
            footerEl.innerText = (pageRevenue >= 0 ? '+' : '') + pageRevenue.toFixed(2);
            footerEl.className = `px-5 py-4 text-center font-bold text-lg ${pageRevenue >= 0 ? 'text-emerald-600' : 'text-red-500'}`;

            document.getElementById('pgStart').innerText = filteredData.length > 0 ? start + 1 : 0;
            document.getElementById('pgEnd').innerText = Math.min(end, filteredData.length);
            document.getElementById('pgTotal').innerText = filteredData.length;
        }

        function nextPage() {
            if ((currentPage * rowsPerPage) < filteredData.length) {
                currentPage++;
                renderTable();
            }
        }
        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                renderTable();
            }
        }

        // --- CHART ANALYTICS LOGIC ---
        function updateCharts() {
            if (filteredData.length === 0) return;

            // 1. Win Rate Trend (Line)
            const dateGroups = {};
            filteredData.forEach(d => {
                if (!dateGroups[d['Date']]) dateGroups[d['Date']] = { total: 0, wins: 0 };
                dateGroups[d['Date']].total++;
                if (isPredictionCorrect(d['Match Result'], d['Model Prediction'])) dateGroups[d['Date']].wins++;
            });
            const sortedDates = Object.keys(dateGroups).sort();
            const winRates = sortedDates.map(date => {
                const g = dateGroups[date];
                return g.total > 0 ? (g.wins / g.total) * 100 : 0;
            });
            
            renderChart('chartTrend', 'line', {
                labels: sortedDates,
                datasets: [{
                    label: 'Win Rate %',
                    data: winRates,
                    borderColor: '#18B26B',
                    backgroundColor: 'rgba(24, 178, 107, 0.1)',
                    tension: 0.3,
                    fill: true
                }]
            });

            // 2. Model Effectiveness (Quick Tip categories)
            const modelGroups = {};
            filteredData.forEach(d => {
                const key = d['Quick Tip'] || 'Standard';
                if (!modelGroups[key]) modelGroups[key] = { total: 0, wins: 0 };
                modelGroups[key].total++;
                if (isPredictionCorrect(d['Match Result'], d['Model Prediction'])) modelGroups[key].wins++;
            });
            const models = Object.keys(modelGroups);
            const modelRates = models.map(m => (modelGroups[m].total > 0 ? (modelGroups[m].wins / modelGroups[m].total) * 100 : 0));
            
            renderChart('chartModel', 'bar', {
                labels: models,
                datasets: [{
                    label: 'Win Rate %',
                    data: modelRates,
                    backgroundColor: models.map(m => m === 'Perfect' ? '#F2C94C' : '#1E6FFF'),
                }]
            });

            // 3. Confidence Accuracy (Combo)
            const confBuckets = ['0-40', '41-60', '61-75', '76-90', '91-100'];
            const confData = confBuckets.map(() => ({ total: 0, wins: 0 }));
            
            filteredData.forEach(d => {
                const c = parseFloat(d['Confidence %']) || 0;
                let idx = 0;
                if (c > 40 && c <= 60) idx = 1;
                else if (c > 60 && c <= 75) idx = 2;
                else if (c > 75 && c <= 90) idx = 3;
                else if (c > 90) idx = 4;
                
                confData[idx].total++;
                if (isPredictionCorrect(d['Match Result'], d['Model Prediction'])) confData[idx].wins++;
            });

            renderChart('chartConfidence', 'bar', {
                labels: confBuckets,
                datasets: [
                    {
                        type: 'line',
                        label: 'Win Rate %',
                        data: confData.map(d => d.total > 0 ? (d.wins/d.total)*100 : 0),
                        borderColor: '#F2C94C',
                        borderWidth: 2,
                        yAxisID: 'y1'
                    },
                    {
                        type: 'bar',
                        label: 'Volume',
                        data: confData.map(d => d.total),
                        backgroundColor: '#1E6FFF',
                        yAxisID: 'y'
                    }
                ]
            });

            // 4. Outcome Bias (Doughnut)
            const outcomes = { 'Home': 0, 'Draw': 0, 'Away': 0 };
            filteredData.forEach(d => {
                const p = d['Model Prediction'];
                if (p === '1' || p === 'Home') outcomes['Home']++;
                else if (p === 'X' || p === 'Draw') outcomes['Draw']++;
                else if (p === '2' || p === 'Away') outcomes['Away']++;
            });

            renderChart('chartOutcome', 'doughnut', {
                labels: ['Home', 'Draw', 'Away'],
                datasets: [{
                    data: [outcomes['Home'], outcomes['Draw'], outcomes['Away']],
                    backgroundColor: ['#1E6FFF', '#F2C94C', '#18B26B']
                }]
            });
            
             // 5. Correct Score Freq (Bar)
            const csCounts = {};
            filteredData.forEach(d => {
                const cs = d['Correct Score'];
                if(cs) csCounts[cs] = (csCounts[cs] || 0) + 1;
            });
            // Top 10 scores
            const sortedCS = Object.entries(csCounts).sort((a,b) => b[1] - a[1]).slice(0, 10);
            
            renderChart('chartCS', 'bar', {
                labels: sortedCS.map(x => x[0]),
                datasets: [{
                    label: 'Count',
                    data: sortedCS.map(x => x[1]),
                    backgroundColor: '#0B1C2D'
                }]
            });
        }

        function renderChart(canvasId, type, data) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            
            // Destroy existing chart
            if (charts[canvasId]) {
                charts[canvasId].destroy();
            }

            // Create new chart
            charts[canvasId] = new Chart(ctx, {
                type: type,
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                            backgroundColor: '#0B1C2D',
                            titleColor: '#F2C94C',
                            bodyColor: '#fff',
                            displayColors: true,
                        }
                    },
                    scales: type === 'doughnut' ? {} : {
                        y: { beginAtZero: true, grid: { color: '#f1f5f9' } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }


        // --- Helper Logic ---
        function populateDropdown(id, key) {
            const select = document.getElementById(id);
            const values = [...new Set(allData.map(d => d[key]))].sort().filter(v => v);
            
            // Keep first option (placeholder)
            select.innerHTML = select.options[0].outerHTML;
            values.forEach(v => {
                const opt = document.createElement('option');
                opt.value = v;
                opt.innerText = v;
                select.appendChild(opt);
            });
        }

        function isPredictionCorrect(result, prediction) {
            if (!result || result === '-' || result === '?' || !prediction) return false;
            
            const parts = result.split('-');
            if (parts.length !== 2) return false;
            
            const h = parseInt(parts[0]);
            const a = parseInt(parts[1]);
            
            let actual = 'Draw';
            if (h > a) actual = 'Home';
            if (a > h) actual = 'Away';
            
            const p = prediction.toLowerCase();
            if (p === '1' || p === 'home') return actual === 'Home';
            if (p === '2' || p === 'away') return actual === 'Away';
            if (p === 'x' || p === 'draw') return actual === 'Draw';
            
            return false;
        }

        // --- Modals ---
        function viewMatch(matchKey) {
            // Find row by MatchKey (updated logic from index lookup to Key lookup for robustness)
            const d = allData.find(row => row['MatchKey'] === matchKey); 
            // Fallback for button if needed, but we use MatchKey now
            
            if (!d) return;

            // Header
            document.getElementById('md_league').innerText = d['League'];
            document.getElementById('md_date').innerText = d['Date'];
            document.getElementById('md_home').innerText = d['Home Team'];
            document.getElementById('md_away').innerText = d['Away Team'];
            
            const res = d['Match Result'];
            if(res && res !== '-' && res !== '?') {
                 document.getElementById('md_score').innerText = res;
            } else {
                document.getElementById('md_score').innerText = 'VS';
            }

            // Team & Form
            document.getElementById('md_h_form').innerText = d['Home Form'];
            document.getElementById('md_h_pos').innerText = d['Home Position'];
            document.getElementById('md_h_power').innerText = d['Home Power'];
            
            document.getElementById('md_a_form').innerText = d['Away Form'];
            document.getElementById('md_a_pos').innerText = d['Away Position'];
            document.getElementById('md_a_power').innerText = d['Away Power'];

            // Scoring Metrics
            document.getElementById('md_h_sc_avg').innerText = d['Home Scored Avg'];
            document.getElementById('md_h_con_avg').innerText = d['Home Conceded Avg'];
            document.getElementById('md_a_sc_avg').innerText = d['Away Scored Avg'];
            document.getElementById('md_a_con_avg').innerText = d['Away Conceded Avg'];

            // H2H Bars & Numbers
            const hWin = parseInt(d['H2H Home Wins']) || 0;
            const aWin = parseInt(d['H2H Away Wins']) || 0;
            // Try to find Draw or use 0
            const draw = d['H2H Draws'] ? parseInt(d['H2H Draws']) : 0; 
            
            document.getElementById('md_h2h_h').innerText = hWin;
            document.getElementById('md_h2h_d').innerText = draw;
            document.getElementById('md_h2h_a').innerText = aWin;

            // Simple bar width calc
            const totalH2H = hWin + aWin + draw + 0.1; // avoid div by 0
            document.getElementById('bar_h2h_h').style.width = `${(hWin/totalH2H)*100}%`;
            document.getElementById('bar_h2h_d').style.width = `${(draw/totalH2H)*100}%`;
            document.getElementById('bar_h2h_a').style.width = `${(aWin/totalH2H)*100}%`;
            
            // Model Centerpiece
            document.getElementById('md_model_goals').innerText = d['Model Goals'];
            document.getElementById('md_prediction').innerText = d['Model Prediction'];
            document.getElementById('md_prob').innerText = `Prob: ${d['Model Probability %']}%`;
            document.getElementById('md_cs').innerText = d['Correct Score'];

            // Differentials with Color Coding
            const setDiff = (id, val) => {
                const el = document.getElementById(id);
                el.innerText = val;
                const n = parseFloat(val);
                if(n > 0) { el.className = "font-bold text-sm text-brand-green"; el.innerHTML += ' <i class="fa-solid fa-caret-up text-[10px] ml-1"></i>'; }
                else if(n < 0) { el.className = "font-bold text-sm text-red-500"; el.innerHTML += ' <i class="fa-solid fa-caret-down text-[10px] ml-1"></i>'; }
                else el.className = "font-bold text-sm text-gray-400";
            }

            setDiff('md_diff_power', d['Power Difference']);
            setDiff('md_diff_form', d['Form Difference']);
            setDiff('md_diff_scored', d['Scored Difference']);
            setDiff('md_diff_conceded', d['Conceded Difference']);
            
            // Calc explicit diffs for others if missing in CSV columns
            const posDiff = (parseFloat(d['Home Position']) - parseFloat(d['Away Position'])).toFixed(0);
            setDiff('md_diff_pos', posDiff); 
            
            const h2hDiff = (hWin - aWin).toFixed(0);
            setDiff('md_diff_h2h', h2hDiff);

            document.getElementById('md_link').href = d['Match URL'] || '#';

            openModal('matchDetailsModal');
        }

        function openModal(id) {
            document.getElementById(id).classList.remove('hidden');
            document.getElementById(id).classList.add('flex');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('flex');
            document.getElementById(id).classList.add('hidden');
        }

        function toggleExport() {
            const tableEl = document.getElementById('tableExportWrapper');
            const originalOverflow = tableEl.style.overflow;
            tableEl.style.overflow = 'visible'; 
            
            html2canvas(tableEl).then(canvas => {
                tableEl.style.overflow = originalOverflow;
                const link = document.createElement('a');
                link.download = `match_analytics_${new Date().toISOString().slice(0,10)}.png`;
                link.href = canvas.toDataURL();
                link.click();
            }).catch(err => {
                console.error("Export failed", err);
                alert("Could not export image.");
            });
        }
    </script>
</body>
</html>
